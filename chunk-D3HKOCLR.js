import{a as z}from"./chunk-XNGY4TGQ.js";import{A as u,I as b,Q as m,V as j,a as d,b as y,c as i,d as v,e as k,h as x,l as g,p as C}from"./chunk-PDD7UHS3.js";var O=class s{currentUserSubject=new g(null);currentUser$=this.currentUserSubject.asObservable();progressSubject=new g(null);progress$=this.progressSubject.asObservable();constructor(){this.loadUser(),this.loadProgress()}loadUser(){let e=localStorage.getItem("user_profile");if(e)this.currentUserSubject.next(JSON.parse(e));else{let t={id:this.generateId(),levelPreference:"highschool",topics:[],createdAt:new Date().toISOString(),preferences:{defaultMode:"explain",defaultTopK:5,enableStreaming:!0,enableOfflineMode:!1}};this.setUser(t)}}loadProgress(){let e=localStorage.getItem("user_progress");if(e)this.progressSubject.next(JSON.parse(e));else{let t=this.currentUserSubject.value;if(t){let r={userId:t.id,totalQuestions:0,correctAnswers:0,activeMinutes:0,topicMastery:{},lastActive:new Date().toISOString()};this.setProgress(r)}}}setUser(e){localStorage.setItem("user_profile",JSON.stringify(e)),this.currentUserSubject.next(e)}updateUserPreferences(e){let t=this.currentUserSubject.value;if(t){let r=d(d({},t),e);this.setUser(r)}}setLevel(e){this.updateUserPreferences({levelPreference:e})}addTopic(e){let t=this.currentUserSubject.value;if(t){let r=t.topics||[];r.includes(e)||this.updateUserPreferences({topics:[...r,e]})}}setProgress(e){localStorage.setItem("user_progress",JSON.stringify(e)),this.progressSubject.next(e)}recordQuizResult(e,t){let r=this.progressSubject.value;if(!r)return;r.totalQuestions++,t&&r.correctAnswers++,r.topicMastery[e]||(r.topicMastery[e]={topic:e,questionsAnswered:0,accuracy:0,daysStudied:1,lastStudied:new Date().toISOString(),masteryLevel:"beginner"});let n=r.topicMastery[e];n.questionsAnswered++,n.accuracy=(n.accuracy*(n.questionsAnswered-1)+(t?1:0))/n.questionsAnswered,n.lastStudied=new Date().toISOString(),n.masteryLevel=this.calculateMasteryLevel(n.accuracy,n.questionsAnswered),r.lastActive=new Date().toISOString(),this.setProgress(r)}recordStudyTime(e){let t=this.progressSubject.value;t&&(t.activeMinutes+=e,t.lastActive=new Date().toISOString(),this.setProgress(t))}calculateMasteryLevel(e,t){return t<5?"beginner":e>=.9&&t>=20?"expert":e>=.8&&t>=10?"advanced":e>=.6?"intermediate":"beginner"}generateId(){return`user_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}getCurrentUser(){return this.currentUserSubject.value}getProgress(){return this.progressSubject.value}exportData(){let e=this.currentUserSubject.value,t=this.progressSubject.value,r={user:e,progress:t,exportedAt:new Date().toISOString()};return JSON.stringify(r,null,2)}clearData(){localStorage.removeItem("user_profile"),localStorage.removeItem("user_progress"),this.loadUser(),this.loadProgress()}static \u0275fac=function(t){return new(t||s)};static \u0275prov=m({token:s,factory:s.\u0275fac,providedIn:"root"})};var S=(s,e)=>e.some(t=>s instanceof t),E,R;function W(){return E||(E=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function _(){return R||(R=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}var I=new WeakMap,D=new WeakMap,f=new WeakMap;function H(s){let e=new Promise((t,r)=>{let n=()=>{s.removeEventListener("success",o),s.removeEventListener("error",a)},o=()=>{t(p(s.result)),n()},a=()=>{r(s.error),n()};s.addEventListener("success",o),s.addEventListener("error",a)});return f.set(e,s),e}function J(s){if(I.has(s))return;let e=new Promise((t,r)=>{let n=()=>{s.removeEventListener("complete",o),s.removeEventListener("error",a),s.removeEventListener("abort",a)},o=()=>{t(),n()},a=()=>{r(s.error||new DOMException("AbortError","AbortError")),n()};s.addEventListener("complete",o),s.addEventListener("error",a),s.addEventListener("abort",a)});I.set(s,e)}var A={get(s,e,t){if(s instanceof IDBTransaction){if(e==="done")return I.get(s);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return p(s[e])},set(s,e,t){return s[e]=t,!0},has(s,e){return s instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in s}};function L(s){A=s(A)}function K(s){return _().includes(s)?function(...e){return s.apply(B(this),e),p(this.request)}:function(...e){return p(s.apply(B(this),e))}}function G(s){return typeof s=="function"?K(s):(s instanceof IDBTransaction&&J(s),S(s,W())?new Proxy(s,A):s)}function p(s){if(s instanceof IDBRequest)return H(s);if(D.has(s))return D.get(s);let e=G(s);return e!==s&&(D.set(s,e),f.set(e,s)),e}var B=s=>f.get(s);function T(s,e,{blocked:t,upgrade:r,blocking:n,terminated:o}={}){let a=indexedDB.open(s,e),l=p(a);return r&&a.addEventListener("upgradeneeded",c=>{r(p(a.result),c.oldVersion,c.newVersion,p(a.transaction),c)}),t&&a.addEventListener("blocked",c=>t(c.oldVersion,c.newVersion,c)),l.then(c=>{o&&c.addEventListener("close",()=>o()),n&&c.addEventListener("versionchange",h=>n(h.oldVersion,h.newVersion,h))}).catch(()=>{}),l}var X=["get","getKey","getAll","getAllKeys","count"],Y=["put","add","delete","clear"],w=new Map;function M(s,e){if(!(s instanceof IDBDatabase&&!(e in s)&&typeof e=="string"))return;if(w.get(e))return w.get(e);let t=e.replace(/FromIndex$/,""),r=e!==t,n=Y.includes(t);if(!(t in(r?IDBIndex:IDBObjectStore).prototype)||!(n||X.includes(t)))return;let o=function(a,...l){return i(this,null,function*(){let c=this.transaction(a,n?"readwrite":"readonly"),h=c.store;return r&&(h=h.index(l.shift())),(yield Promise.all([h[t](...l),n&&c.done]))[0]})};return w.set(e,o),o}L(s=>y(d({},s),{get:(e,t,r)=>M(e,t)||s.get(e,t,r),has:(e,t)=>!!M(e,t)||s.has(e,t)}));var Z=["continue","continuePrimaryKey","advance"],F={},P=new WeakMap,N=new WeakMap,ee={get(s,e){if(!Z.includes(e))return s[e];let t=F[e];return t||(t=F[e]=function(...r){P.set(this,N.get(this)[e](...r))}),t}};function te(...s){return k(this,null,function*(){let e=this;if(e instanceof IDBCursor||(e=yield new v(e.openCursor(...s))),!e)return;e=e;let t=new Proxy(e,ee);for(N.set(t,e),f.set(t,B(e));e;)yield t,e=yield new v(P.get(t)||e.continue()),P.delete(t)})}function q(s,e){return e===Symbol.asyncIterator&&S(s,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&S(s,[IDBIndex,IDBObjectStore])}L(s=>y(d({},s),{get(e,t,r){return q(e,t)?te:s.get(e,t,r)},has(e,t){return q(e,t)||s.has(e,t)}}));var $=class s{db=null;DB_NAME="StudyBuddyDB";DB_VERSION=1;init(){return i(this,null,function*(){this.db||(this.db=yield T(this.DB_NAME,this.DB_VERSION,{upgrade(e){if(!e.objectStoreNames.contains("documents")){let t=e.createObjectStore("documents",{keyPath:"id"});t.createIndex("by-status","status"),t.createIndex("by-uploadedAt","uploadedAt")}if(e.objectStoreNames.contains("chunks")||e.createObjectStore("chunks",{keyPath:"id"}).createIndex("by-docId","docId"),e.objectStoreNames.contains("conversations")||e.createObjectStore("conversations",{keyPath:"id"}).createIndex("by-updatedAt","updatedAt"),e.objectStoreNames.contains("quizzes")||e.createObjectStore("quizzes",{keyPath:"id"}).createIndex("by-createdAt","createdAt"),!e.objectStoreNames.contains("quizAttempts")){let t=e.createObjectStore("quizAttempts",{keyPath:"id"});t.createIndex("by-quizId","quizId"),t.createIndex("by-completedAt","completedAt")}if(!e.objectStoreNames.contains("flashcards")){let t=e.createObjectStore("flashcards",{keyPath:"id"});t.createIndex("by-deckId","deckId"),t.createIndex("by-nextReview","nextReview")}e.objectStoreNames.contains("decks")||e.createObjectStore("decks",{keyPath:"id"}).createIndex("by-updatedAt","updatedAt"),e.objectStoreNames.contains("sessions")||e.createObjectStore("sessions",{keyPath:"id"}).createIndex("by-startTime","startTime")}}))})}ensureDB(){return i(this,null,function*(){return this.db||(yield this.init()),this.db})}saveDocument(e){return i(this,null,function*(){yield(yield this.ensureDB()).put("documents",e)})}getDocument(e){return i(this,null,function*(){return(yield this.ensureDB()).get("documents",e)})}getAllDocuments(){return i(this,null,function*(){return(yield this.ensureDB()).getAll("documents")})}deleteDocument(e){return i(this,null,function*(){let t=yield this.ensureDB();yield t.delete("documents",e);let r=yield t.getAllFromIndex("chunks","by-docId",e);for(let n of r)yield t.delete("chunks",n.id)})}saveChunk(e){return i(this,null,function*(){yield(yield this.ensureDB()).put("chunks",e)})}getChunksByDocId(e){return i(this,null,function*(){return(yield this.ensureDB()).getAllFromIndex("chunks","by-docId",e)})}searchChunks(e,t=5){return i(this,null,function*(){return(yield(yield this.ensureDB()).getAll("chunks")).map(a=>({chunk:a,score:this.calculateTextSimilarity(e.toLowerCase(),a.text.toLowerCase())})).sort((a,l)=>l.score-a.score).slice(0,t).map(a=>a.chunk)})}calculateTextSimilarity(e,t){let r=e.split(/\s+/),n=0;for(let o of r)t.includes(o)&&(n+=1);return n/r.length}saveConversation(e){return i(this,null,function*(){yield(yield this.ensureDB()).put("conversations",e)})}getConversation(e){return i(this,null,function*(){return(yield this.ensureDB()).get("conversations",e)})}getAllConversations(){return i(this,null,function*(){return(yield(yield this.ensureDB()).getAll("conversations")).sort((r,n)=>new Date(n.updatedAt||n.createdAt).getTime()-new Date(r.updatedAt||r.createdAt).getTime())})}deleteConversation(e){return i(this,null,function*(){yield(yield this.ensureDB()).delete("conversations",e)})}saveQuiz(e){return i(this,null,function*(){yield(yield this.ensureDB()).put("quizzes",e)})}getQuiz(e){return i(this,null,function*(){return(yield this.ensureDB()).get("quizzes",e)})}getAllQuizzes(){return i(this,null,function*(){return(yield this.ensureDB()).getAll("quizzes")})}saveQuizAttempt(e){return i(this,null,function*(){yield(yield this.ensureDB()).put("quizAttempts",e)})}getQuizAttempts(e){return i(this,null,function*(){return(yield this.ensureDB()).getAllFromIndex("quizAttempts","by-quizId",e)})}saveFlashcard(e){return i(this,null,function*(){yield(yield this.ensureDB()).put("flashcards",e)})}getFlashcard(e){return i(this,null,function*(){return(yield this.ensureDB()).get("flashcards",e)})}getFlashcardsByDeck(e){return i(this,null,function*(){return(yield this.ensureDB()).getAllFromIndex("flashcards","by-deckId",e)})}getDueFlashcards(){return i(this,null,function*(){let t=yield(yield this.ensureDB()).getAll("flashcards"),r=new Date().toISOString();return t.filter(n=>n.nextReview<=r)})}deleteFlashcard(e){return i(this,null,function*(){yield(yield this.ensureDB()).delete("flashcards",e)})}saveDeck(e){return i(this,null,function*(){yield(yield this.ensureDB()).put("decks",e)})}getDeck(e){return i(this,null,function*(){return(yield this.ensureDB()).get("decks",e)})}getAllDecks(){return i(this,null,function*(){return(yield this.ensureDB()).getAll("decks")})}deleteDeck(e){return i(this,null,function*(){let t=yield this.ensureDB();yield t.delete("decks",e);let r=yield this.getFlashcardsByDeck(e);for(let n of r)yield t.delete("flashcards",n.id)})}saveSession(e){return i(this,null,function*(){yield(yield this.ensureDB()).put("sessions",e)})}getRecentSessions(e=10){return i(this,null,function*(){return(yield(yield this.ensureDB()).getAll("sessions")).sort((n,o)=>new Date(o.startTime).getTime()-new Date(n.startTime).getTime()).slice(0,e)})}clearAllData(){return i(this,null,function*(){let e=yield this.ensureDB(),t=["documents","chunks","conversations","quizzes","quizAttempts","flashcards","decks","sessions"];for(let r of t){let n=e.transaction(r,"readwrite");yield n.store.clear(),yield n.done}})}exportAllData(){return i(this,null,function*(){let e=yield this.ensureDB();return{documents:yield e.getAll("documents"),chunks:yield e.getAll("chunks"),conversations:yield e.getAll("conversations"),quizzes:yield e.getAll("quizzes"),quizAttempts:yield e.getAll("quizAttempts"),flashcards:yield e.getAll("flashcards"),decks:yield e.getAll("decks"),sessions:yield e.getAll("sessions"),exportedAt:new Date().toISOString()}})}static \u0275fac=function(t){return new(t||s)};static \u0275prov=m({token:s,factory:s.\u0275fac,providedIn:"root"})};var Q={production:!0,apiUrl:"https://studybuddy-worker.bsse23094.workers.dev"};var V=class s{constructor(e){this.http=e}apiBaseUrl=Q.apiUrl+"/api";streamingSubject=new g(null);streaming$=this.streamingSubject.asObservable();setApiBaseUrl(e){this.apiBaseUrl=e}chat(e){return e.options.stream?this.chatStream(e):this.http.post(`${this.apiBaseUrl}/chat`,e).pipe(b(2),u(this.handleError))}chatStream(e){return new x(t=>{let r={success:!0,data:{conversationId:e.conversationId||this.generateId(),message:{id:this.generateId(),role:"assistant",content:"Streaming response simulation...",timestamp:new Date().toISOString(),meta:{mode:e.options.mode,level:e.options.level}},sources:[]},meta:{timestamp:new Date().toISOString(),provider:"mock"}};t.next(r),t.complete()})}generateQuiz(e){return this.http.post(`${this.apiBaseUrl}/quiz/generate`,e).pipe(b(1),u(this.handleError))}generateFlashcards(e){return this.http.post(`${this.apiBaseUrl}/flashcards/generate`,e).pipe(b(1),u(this.handleError))}uploadDocument(e,t){let r=new FormData;return r.append("file",e),t&&r.append("metadata",JSON.stringify(t)),this.http.post(`${this.apiBaseUrl}/documents/upload`,r).pipe(u(this.handleError))}getDocumentStatus(e){return this.http.get(`${this.apiBaseUrl}/documents/${e}/status`).pipe(u(this.handleError))}searchDocuments(e,t){return this.http.post(`${this.apiBaseUrl}/documents/search`,d({query:e},t)).pipe(u(this.handleError))}getHealth(){return this.http.get(`${this.apiBaseUrl}/health`).pipe(u(this.handleError))}handleError(e){let t="An error occurred";return e.error instanceof ErrorEvent?t=`Error: ${e.error.message}`:t=`Error Code: ${e.status}
Message: ${e.message}`,console.error(t),C(()=>new Error(t))}generateId(){return`${Date.now()}_${Math.random().toString(36).substr(2,9)}`}static \u0275fac=function(t){return new(t||s)(j(z))};static \u0275prov=m({token:s,factory:s.\u0275fac,providedIn:"root"})};export{O as a,$ as b,V as c};
