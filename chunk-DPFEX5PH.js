import{a as R}from"./chunk-BIGFIPF2.js";import{a as E}from"./chunk-6BQ6EQPT.js";import{A as d,I as p,Q as y,V as C,a as m,b as g,c as r,d as f,e as k,h as P,l as x,p as z}from"./chunk-JSD32Q4O.js";var v=(s,e)=>e.some(t=>s instanceof t),O,j;function U(){return O||(O=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function V(){return j||(j=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}var B=new WeakMap,D=new WeakMap,b=new WeakMap;function W(s){let e=new Promise((t,n)=>{let a=()=>{s.removeEventListener("success",o),s.removeEventListener("error",i)},o=()=>{t(h(s.result)),a()},i=()=>{n(s.error),a()};s.addEventListener("success",o),s.addEventListener("error",i)});return b.set(e,s),e}function H(s){if(B.has(s))return;let e=new Promise((t,n)=>{let a=()=>{s.removeEventListener("complete",o),s.removeEventListener("error",i),s.removeEventListener("abort",i)},o=()=>{t(),a()},i=()=>{n(s.error||new DOMException("AbortError","AbortError")),a()};s.addEventListener("complete",o),s.addEventListener("error",i),s.addEventListener("abort",i)});B.set(s,e)}var A={get(s,e,t){if(s instanceof IDBTransaction){if(e==="done")return B.get(s);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return h(s[e])},set(s,e,t){return s[e]=t,!0},has(s,e){return s instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in s}};function M(s){A=s(A)}function K(s){return V().includes(s)?function(...e){return s.apply(S(this),e),h(this.request)}:function(...e){return h(s.apply(S(this),e))}}function _(s){return typeof s=="function"?K(s):(s instanceof IDBTransaction&&H(s),v(s,U())?new Proxy(s,A):s)}function h(s){if(s instanceof IDBRequest)return W(s);if(D.has(s))return D.get(s);let e=_(s);return e!==s&&(D.set(s,e),b.set(e,s)),e}var S=s=>b.get(s);function N(s,e,{blocked:t,upgrade:n,blocking:a,terminated:o}={}){let i=indexedDB.open(s,e),u=h(i);return n&&i.addEventListener("upgradeneeded",c=>{n(h(i.result),c.oldVersion,c.newVersion,h(i.transaction),c)}),t&&i.addEventListener("blocked",c=>t(c.oldVersion,c.newVersion,c)),u.then(c=>{o&&c.addEventListener("close",()=>o()),a&&c.addEventListener("versionchange",l=>a(l.oldVersion,l.newVersion,l))}).catch(()=>{}),u}var J=["get","getKey","getAll","getAllKeys","count"],G=["put","add","delete","clear"],w=new Map;function F(s,e){if(!(s instanceof IDBDatabase&&!(e in s)&&typeof e=="string"))return;if(w.get(e))return w.get(e);let t=e.replace(/FromIndex$/,""),n=e!==t,a=G.includes(t);if(!(t in(n?IDBIndex:IDBObjectStore).prototype)||!(a||J.includes(t)))return;let o=function(i,...u){return r(this,null,function*(){let c=this.transaction(i,a?"readwrite":"readonly"),l=c.store;return n&&(l=l.index(u.shift())),(yield Promise.all([l[t](...u),a&&c.done]))[0]})};return w.set(e,o),o}M(s=>g(m({},s),{get:(e,t,n)=>F(e,t)||s.get(e,t,n),has:(e,t)=>!!F(e,t)||s.has(e,t)}));var X=["continue","continuePrimaryKey","advance"],q={},I=new WeakMap,$=new WeakMap,Y={get(s,e){if(!X.includes(e))return s[e];let t=q[e];return t||(t=q[e]=function(...n){I.set(this,$.get(this)[e](...n))}),t}};function Z(...s){return k(this,null,function*(){let e=this;if(e instanceof IDBCursor||(e=yield new f(e.openCursor(...s))),!e)return;e=e;let t=new Proxy(e,Y);for($.set(t,e),b.set(t,S(e));e;)yield t,e=yield new f(I.get(t)||e.continue()),I.delete(t)})}function T(s,e){return e===Symbol.asyncIterator&&v(s,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&v(s,[IDBIndex,IDBObjectStore])}M(s=>g(m({},s),{get(e,t,n){return T(e,t)?Z:s.get(e,t,n)},has(e,t){return T(e,t)||s.has(e,t)}}));var L=class s{db=null;DB_NAME="StudyBuddyDB";DB_VERSION=1;init(){return r(this,null,function*(){this.db||(this.db=yield N(this.DB_NAME,this.DB_VERSION,{upgrade(e){if(!e.objectStoreNames.contains("documents")){let t=e.createObjectStore("documents",{keyPath:"id"});t.createIndex("by-status","status"),t.createIndex("by-uploadedAt","uploadedAt")}if(e.objectStoreNames.contains("chunks")||e.createObjectStore("chunks",{keyPath:"id"}).createIndex("by-docId","docId"),e.objectStoreNames.contains("conversations")||e.createObjectStore("conversations",{keyPath:"id"}).createIndex("by-updatedAt","updatedAt"),e.objectStoreNames.contains("quizzes")||e.createObjectStore("quizzes",{keyPath:"id"}).createIndex("by-createdAt","createdAt"),!e.objectStoreNames.contains("quizAttempts")){let t=e.createObjectStore("quizAttempts",{keyPath:"id"});t.createIndex("by-quizId","quizId"),t.createIndex("by-completedAt","completedAt")}if(!e.objectStoreNames.contains("flashcards")){let t=e.createObjectStore("flashcards",{keyPath:"id"});t.createIndex("by-deckId","deckId"),t.createIndex("by-nextReview","nextReview")}e.objectStoreNames.contains("decks")||e.createObjectStore("decks",{keyPath:"id"}).createIndex("by-updatedAt","updatedAt"),e.objectStoreNames.contains("sessions")||e.createObjectStore("sessions",{keyPath:"id"}).createIndex("by-startTime","startTime")}}))})}ensureDB(){return r(this,null,function*(){return this.db||(yield this.init()),this.db})}saveDocument(e){return r(this,null,function*(){yield(yield this.ensureDB()).put("documents",e)})}getDocument(e){return r(this,null,function*(){return(yield this.ensureDB()).get("documents",e)})}getAllDocuments(){return r(this,null,function*(){return(yield this.ensureDB()).getAll("documents")})}deleteDocument(e){return r(this,null,function*(){let t=yield this.ensureDB();yield t.delete("documents",e);let n=yield t.getAllFromIndex("chunks","by-docId",e);for(let a of n)yield t.delete("chunks",a.id)})}saveChunk(e){return r(this,null,function*(){yield(yield this.ensureDB()).put("chunks",e)})}getChunksByDocId(e){return r(this,null,function*(){return(yield this.ensureDB()).getAllFromIndex("chunks","by-docId",e)})}searchChunks(e,t=5){return r(this,null,function*(){return(yield(yield this.ensureDB()).getAll("chunks")).map(i=>({chunk:i,score:this.calculateTextSimilarity(e.toLowerCase(),i.text.toLowerCase())})).sort((i,u)=>u.score-i.score).slice(0,t).map(i=>i.chunk)})}calculateTextSimilarity(e,t){let n=e.split(/\s+/),a=0;for(let o of n)t.includes(o)&&(a+=1);return a/n.length}saveConversation(e){return r(this,null,function*(){yield(yield this.ensureDB()).put("conversations",e)})}getConversation(e){return r(this,null,function*(){return(yield this.ensureDB()).get("conversations",e)})}getAllConversations(){return r(this,null,function*(){return(yield(yield this.ensureDB()).getAll("conversations")).sort((n,a)=>new Date(a.updatedAt||a.createdAt).getTime()-new Date(n.updatedAt||n.createdAt).getTime())})}deleteConversation(e){return r(this,null,function*(){yield(yield this.ensureDB()).delete("conversations",e)})}saveQuiz(e){return r(this,null,function*(){yield(yield this.ensureDB()).put("quizzes",e)})}getQuiz(e){return r(this,null,function*(){return(yield this.ensureDB()).get("quizzes",e)})}getAllQuizzes(){return r(this,null,function*(){return(yield this.ensureDB()).getAll("quizzes")})}saveQuizAttempt(e){return r(this,null,function*(){yield(yield this.ensureDB()).put("quizAttempts",e)})}getQuizAttempts(e){return r(this,null,function*(){return(yield this.ensureDB()).getAllFromIndex("quizAttempts","by-quizId",e)})}saveFlashcard(e){return r(this,null,function*(){yield(yield this.ensureDB()).put("flashcards",e)})}getFlashcard(e){return r(this,null,function*(){return(yield this.ensureDB()).get("flashcards",e)})}getFlashcardsByDeck(e){return r(this,null,function*(){return(yield this.ensureDB()).getAllFromIndex("flashcards","by-deckId",e)})}getDueFlashcards(){return r(this,null,function*(){let t=yield(yield this.ensureDB()).getAll("flashcards"),n=new Date().toISOString();return t.filter(a=>a.nextReview<=n)})}deleteFlashcard(e){return r(this,null,function*(){yield(yield this.ensureDB()).delete("flashcards",e)})}saveDeck(e){return r(this,null,function*(){yield(yield this.ensureDB()).put("decks",e)})}getDeck(e){return r(this,null,function*(){return(yield this.ensureDB()).get("decks",e)})}getAllDecks(){return r(this,null,function*(){return(yield this.ensureDB()).getAll("decks")})}deleteDeck(e){return r(this,null,function*(){let t=yield this.ensureDB();yield t.delete("decks",e);let n=yield this.getFlashcardsByDeck(e);for(let a of n)yield t.delete("flashcards",a.id)})}saveSession(e){return r(this,null,function*(){yield(yield this.ensureDB()).put("sessions",e)})}getRecentSessions(e=10){return r(this,null,function*(){return(yield(yield this.ensureDB()).getAll("sessions")).sort((a,o)=>new Date(o.startTime).getTime()-new Date(a.startTime).getTime()).slice(0,e)})}clearAllData(){return r(this,null,function*(){let e=yield this.ensureDB(),t=["documents","chunks","conversations","quizzes","quizAttempts","flashcards","decks","sessions"];for(let n of t){let a=e.transaction(n,"readwrite");yield a.store.clear(),yield a.done}})}exportAllData(){return r(this,null,function*(){let e=yield this.ensureDB();return{documents:yield e.getAll("documents"),chunks:yield e.getAll("chunks"),conversations:yield e.getAll("conversations"),quizzes:yield e.getAll("quizzes"),quizAttempts:yield e.getAll("quizAttempts"),flashcards:yield e.getAll("flashcards"),decks:yield e.getAll("decks"),sessions:yield e.getAll("sessions"),exportedAt:new Date().toISOString()}})}get(e){return r(this,null,function*(){try{let t=localStorage.getItem(`studybuddy_${e}`);return t?JSON.parse(t):null}catch(t){return console.error("Storage get error:",t),null}})}set(e,t){return r(this,null,function*(){try{localStorage.setItem(`studybuddy_${e}`,JSON.stringify(t))}catch(n){console.error("Storage set error:",n)}})}remove(e){return r(this,null,function*(){try{localStorage.removeItem(`studybuddy_${e}`)}catch(t){console.error("Storage remove error:",t)}})}static \u0275fac=function(t){return new(t||s)};static \u0275prov=y({token:s,factory:s.\u0275fac,providedIn:"root"})};var Q=class s{constructor(e){this.http=e}apiBaseUrl=R.apiUrl+"/api";streamingSubject=new x(null);streaming$=this.streamingSubject.asObservable();setApiBaseUrl(e){this.apiBaseUrl=e}chat(e){return e.options.stream?this.chatStream(e):this.http.post(`${this.apiBaseUrl}/chat`,e).pipe(p(2),d(this.handleError))}chatStream(e){return new P(t=>{let n={success:!0,data:{conversationId:e.conversationId||this.generateId(),message:{id:this.generateId(),role:"assistant",content:"Streaming response simulation...",timestamp:new Date().toISOString(),meta:{mode:e.options.mode,level:e.options.level}},sources:[]},meta:{timestamp:new Date().toISOString(),provider:"mock"}};t.next(n),t.complete()})}generateQuiz(e){return this.http.post(`${this.apiBaseUrl}/quiz/generate`,e).pipe(p(1),d(this.handleError))}generateFlashcards(e){return this.http.post(`${this.apiBaseUrl}/flashcards/generate`,e).pipe(p(1),d(this.handleError))}uploadDocument(e,t){let n=new FormData;return n.append("file",e),t&&n.append("metadata",JSON.stringify(t)),this.http.post(`${this.apiBaseUrl}/documents/upload`,n).pipe(d(this.handleError))}getDocumentStatus(e){return this.http.get(`${this.apiBaseUrl}/documents/${e}/status`).pipe(d(this.handleError))}searchDocuments(e,t){return this.http.post(`${this.apiBaseUrl}/documents/search`,m({query:e},t)).pipe(d(this.handleError))}getHealth(){return this.http.get(`${this.apiBaseUrl}/health`).pipe(d(this.handleError))}handleError(e){let t="An error occurred";return e.error instanceof ErrorEvent?t=`Error: ${e.error.message}`:t=`Error Code: ${e.status}
Message: ${e.message}`,console.error(t),z(()=>new Error(t))}generateId(){return`${Date.now()}_${Math.random().toString(36).substr(2,9)}`}static \u0275fac=function(t){return new(t||s)(C(E))};static \u0275prov=y({token:s,factory:s.\u0275fac,providedIn:"root"})};export{L as a,Q as b};
